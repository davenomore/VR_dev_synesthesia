import{M as c}from"./music-store-Da5ddBIB.js";AFRAME.registerSystem("audio-analyzer",{schema:{fftSize:{default:1024},smoothing:{default:.8}},init:function(){this.audioContext=null,this.analyser=null,this.source=null,this.audio=null,this.frequencyData=null,this.isPlaying=!1,this.bands={bass:0,mid:0,high:0},this.volume=0,this.isBeat=!1,this.beatThreshold=0,this.beatHold=!1,this.beatTimer=0,this.smoothBands={bass:0,mid:0,high:0},this.loadAudio=this.loadAudio.bind(this),this.play=this.play.bind(this),this.pause=this.pause.bind(this),console.log("[AudioAnalyzer] System initialized")},loadAudio:function(t){return new Promise((s,i)=>{this.audioContext||(this.audioContext=new(window.AudioContext||window.webkitAudioContext),this.analyser=this.audioContext.createAnalyser(),this.analyser.fftSize=this.data.fftSize,this.analyser.smoothingTimeConstant=this.data.smoothing,this.frequencyData=new Uint8Array(this.analyser.frequencyBinCount)),this.source&&this.source.disconnect(),this.audio&&(this.audio.pause(),this.audio=null),this.audio=new Audio,this.audio.crossOrigin="anonymous",this.audio.loop=!0,t instanceof File?this.audio.src=URL.createObjectURL(t):this.audio.src=t,this.audio.addEventListener("canplaythrough",()=>{this.source=this.audioContext.createMediaElementSource(this.audio),this.source.connect(this.analyser),this.analyser.connect(this.audioContext.destination),console.log("[AudioAnalyzer] Audio loaded:",t instanceof File?t.name:t),this.el.emit("audio-loaded"),s()},{once:!0}),this.audio.addEventListener("error",e=>{console.error("[AudioAnalyzer] Failed to load audio:",e),i(e)},{once:!0}),this.audio.load()})},play:function(){this.audio&&this.audioContext&&(this.audioContext.state==="suspended"&&this.audioContext.resume(),this.audio.play(),this.isPlaying=!0,this.el.emit("audio-play"),console.log("[AudioAnalyzer] Playing"))},pause:function(){this.audio&&(this.audio.pause(),this.isPlaying=!1,this.el.emit("audio-pause"))},toggle:function(){this.isPlaying?this.pause():this.play()},getBands:function(){return this.smoothBands},getRawBands:function(){return this.bands},tick:function(t,s){if(!this.analyser||!this.isPlaying)return;this.analyser.getByteFrequencyData(this.frequencyData);const i=this.frequencyData;let e=0;for(let a=0;a<4;a++)e+=i[a]||0;this.bands.bass=e/4/255;let o=0,h=0;for(let a=7;a<58;a++)o+=i[a]||0,h++;this.bands.mid=o/h/255;let n=0,l=0;for(let a=90;a<this.analyser.frequencyBinCount;a++)n+=i[a]||0,l++;this.bands.high=n/l/255,this.bands.high=Math.min(this.bands.high*3,1),this.volume=(this.bands.bass+this.bands.mid+this.bands.high)/3;const d=this.bands.bass;this.beatThreshold=this.beatThreshold*.95+d*.05,d>this.beatThreshold*1.3&&d>.3?this.beatHold||(this.isBeat=!0,this.beatHold=!0,this.el.emit("audio-beat",{level:d})):this.isBeat=!1,this.beatHold&&(this.beatTimer+=s,this.beatTimer>100&&(this.beatHold=!1,this.beatTimer=0));const r=.6;this.smoothBands.bass+=(this.bands.bass-this.smoothBands.bass)*r,this.smoothBands.mid+=(this.bands.mid-this.smoothBands.mid)*r,this.smoothBands.high+=(this.bands.high-this.smoothBands.high)*r}});AFRAME.registerComponent("hand-attractor",{schema:{hand:{type:"string"},strength:{default:1},radius:{default:.5}},init:function(){this.isActive=!1;const t=document.querySelector("[synesthetic-particles]");this.particles=t?t.components["synesthetic-particles"]:null,this.position=new THREE.Vector3,this.strength=this.data.strength,this.radius=this.data.radius,this.hand=this.data.hand,console.log(`[HandAttractor] Init ${this.data.hand}`),console.log("[HandAttractor] Setting up listeners on:",this.el),this.el.addEventListener("gesture-pinch",s=>{console.log(`[HandAttractor] ðŸ”¥ GESTURE-PINCH EVENT RECEIVED (${this.data.hand})`,s),this.activate()}),this.el.addEventListener("gesture-pinch-end",s=>{console.log(`[HandAttractor] GESTURE-PINCH-END (${this.data.hand})`),this.deactivate()}),this.el.addEventListener("pinchstarted",()=>{console.log(`[HandAttractor] PINCHSTARTED (${this.data.hand})`),this.activate()}),this.el.addEventListener("pinchended",()=>{console.log(`[HandAttractor] PINCHENDED (${this.data.hand})`),this.deactivate()}),this.el.addEventListener("gripdown",()=>{console.log(`[HandAttractor] GRIPDOWN (${this.data.hand})`),this.activate()}),this.el.addEventListener("gripup",()=>{console.log(`[HandAttractor] GRIPUP (${this.data.hand})`),this.deactivate()}),this.el.addEventListener("gesture-fist",()=>{console.log(`[HandAttractor] GESTURE-FIST (${this.data.hand})`),this.activate("freeze")}),this.el.addEventListener("gesture-fist-end",()=>{console.log(`[HandAttractor] GESTURE-FIST-END (${this.data.hand})`),this.deactivate()}),this.particles||this.el.sceneEl.addEventListener("loaded",()=>{const s=document.querySelector("[synesthetic-particles]");this.particles=s?s.components["synesthetic-particles"]:null})},activate:function(t=null){if(this.isActive&&this.mode===t){console.log(`[HandAttractor] Already active (${this.data.hand})`);return}if(this.isActive=!0,this.mode=t,console.log(`[HandAttractor] âœ… ACTIVATING (${this.data.hand}) Mode: ${t||"standard"}`),!this.particles){const i=document.querySelector("[synesthetic-particles]"),e=document.querySelector("[gpu-particles]");i?(this.particles=i.components["synesthetic-particles"],this.isGPU=!1):e&&(this.particles=e.components["gpu-particles"],this.isGPU=!0)}if(this.particles){if(console.log(`[HandAttractor] ðŸŽ¯ Adding attractor to particle system (${this.data.hand})`),this.isGPU)return;t==="freeze"?(this.strength=0,this.radius=100):(this.strength=50,this.radius=8,t||(t="orb")),this.data.mode=t,this.particles.addAttractor(this)}const s=this.el.components.haptics;s&&s.pulse(.5,50)},deactivate:function(){this.isActive&&(this.isActive=!1,console.log(`[HandAttractor] ðŸ”´ DEACTIVATING (${this.data.hand})`),this.particles&&this.particles.removeAttractor(this))},tick:function(){if(!this.isActive)return;const t=this.el.sceneEl.renderer;if(t&&t.xr){const s=t.xr.getSession(),i=t.xr.getFrame(),e=t.xr.getReferenceSpace();if(s&&i&&e){for(const o of s.inputSources)if(o.handedness===this.data.hand&&o.hand){const h=o.hand.get("wrist");if(h){const n=i.getJointPose(h,e);if(n){this.position.set(n.transform.position.x,n.transform.position.y,n.transform.position.z);return}}}}}this.el.object3D.getWorldPosition(this.position)}});AFRAME.registerComponent("auto-music",{init:function(){const t=async()=>{if(this.system=this.el.sceneEl.systems["audio-analyzer"],this.loaded=!1,!this.system){console.warn("AutoMusic: Audio Analyzer system not found!");return}try{console.log("AutoMusic: Checking store...");const s=await c.getTrack();s?(console.log("AutoMusic: Found track",s.name),await this.system.loadAudio(s),this.loaded=!0,this.tryPlay()):console.log("AutoMusic: No track selected in store.")}catch(s){console.error("AutoMusic: Error loading track",s)}};this.el.sceneEl.hasLoaded?t():this.el.sceneEl.addEventListener("loaded",t),this.el.sceneEl.addEventListener("enter-vr",()=>{this.loaded&&this.tryPlay()}),document.body.addEventListener("click",()=>{this.loaded&&this.tryPlay()},{once:!0}),this.el.sceneEl.addEventListener("play-music",()=>{this.loaded&&this.tryPlay()})},tryPlay:function(){this.system&&(console.log("AutoMusic: Attempting playback..."),this.system.audioContext&&this.system.audioContext.state==="suspended"?(console.log("AutoMusic: Context suspended, resuming..."),this.system.audioContext.resume().then(()=>{console.log("AutoMusic: Context resumed, playing."),this.system.play()}).catch(t=>console.error("AutoMusic: Resume failed",t))):(console.log("AutoMusic: Playing."),this.system.play()))}});
