import{M as C}from"./music-store-Da5ddBIB.js";AFRAME.registerSystem("audio-analyzer",{schema:{fftSize:{default:1024},smoothing:{default:.8}},init:function(){this.audioContext=null,this.analyser=null,this.source=null,this.audio=null,this.frequencyData=null,this.isPlaying=!1,this.bands={bass:0,mid:0,high:0},this.volume=0,this.isBeat=!1,this.beatThreshold=0,this.beatHold=!1,this.beatTimer=0,this.smoothBands={bass:0,mid:0,high:0},this.loadAudio=this.loadAudio.bind(this),this.play=this.play.bind(this),this.pause=this.pause.bind(this),console.log("[AudioAnalyzer] System initialized")},loadAudio:function(t){return new Promise((e,i)=>{this.audioContext||(this.audioContext=new(window.AudioContext||window.webkitAudioContext),this.analyser=this.audioContext.createAnalyser(),this.analyser.fftSize=this.data.fftSize,this.analyser.smoothingTimeConstant=this.data.smoothing,this.frequencyData=new Uint8Array(this.analyser.frequencyBinCount)),this.source&&this.source.disconnect(),this.audio&&(this.audio.pause(),this.audio=null),this.audio=new Audio,this.audio.crossOrigin="anonymous",this.audio.loop=!0,t instanceof File?this.audio.src=URL.createObjectURL(t):this.audio.src=t,this.audio.addEventListener("canplaythrough",()=>{this.source=this.audioContext.createMediaElementSource(this.audio),this.source.connect(this.analyser),this.analyser.connect(this.audioContext.destination),console.log("[AudioAnalyzer] Audio loaded:",t instanceof File?t.name:t),this.el.emit("audio-loaded"),e()},{once:!0}),this.audio.addEventListener("error",n=>{console.error("[AudioAnalyzer] Failed to load audio:",n),i(n)},{once:!0}),this.audio.load()})},play:function(){this.audio&&this.audioContext&&(this.audioContext.state==="suspended"&&this.audioContext.resume(),this.audio.play(),this.isPlaying=!0,this.el.emit("audio-play"),console.log("[AudioAnalyzer] Playing"))},pause:function(){this.audio&&(this.audio.pause(),this.isPlaying=!1,this.el.emit("audio-pause"))},toggle:function(){this.isPlaying?this.pause():this.play()},getBands:function(){return this.smoothBands},getRawBands:function(){return this.bands},tick:function(t,e){if(!this.analyser||!this.isPlaying)return;this.analyser.getByteFrequencyData(this.frequencyData);const i=this.frequencyData;let n=0;for(let r=0;r<4;r++)n+=i[r]||0;this.bands.bass=n/4/255;let s=0,o=0;for(let r=7;r<58;r++)s+=i[r]||0,o++;this.bands.mid=s/o/255;let a=0,c=0;for(let r=90;r<this.analyser.frequencyBinCount;r++)a+=i[r]||0,c++;this.bands.high=a/c/255,this.bands.high=Math.min(this.bands.high*3,1),this.volume=(this.bands.bass+this.bands.mid+this.bands.high)/3;const h=this.bands.bass;this.beatThreshold=this.beatThreshold*.95+h*.05,h>this.beatThreshold*1.3&&h>.3?this.beatHold||(this.isBeat=!0,this.beatHold=!0,this.el.emit("audio-beat",{level:h})):this.isBeat=!1,this.beatHold&&(this.beatTimer+=e,this.beatTimer>100&&(this.beatHold=!1,this.beatTimer=0));const d=.6;this.smoothBands.bass+=(this.bands.bass-this.smoothBands.bass)*d,this.smoothBands.mid+=(this.bands.mid-this.smoothBands.mid)*d,this.smoothBands.high+=(this.bands.high-this.smoothBands.high)*d}});AFRAME.registerSystem("hand-distance",{schema:{minDistance:{default:.05},maxDistance:{default:1}},init:function(){this.leftHand=null,this.rightHand=null,this.leftPos=new THREE.Vector3,this.rightPos=new THREE.Vector3,this.centerPos=new THREE.Vector3,this.distance=.5,this.smoothDistance=.5,this.leftPinching=!1,this.rightPinching=!1,this.leftFist=!1,this.rightFist=!1,this.leftPalmUp=!1,this.rightPalmUp=!1,this.rightIndexTip=new THREE.Vector3,this.rightIndexDir=new THREE.Vector3,this.isRightPointing=!1,this.leftIndexTip=new THREE.Vector3,this.leftIndexDir=new THREE.Vector3,this.isLeftPointing=!1,this.particleSystem=null,this.centerAttractor={data:{hand:"center"},position:new THREE.Vector3,strength:0,radius:0},this.pointingAttractor={data:{hand:"pointing",mode:"attract"},position:new THREE.Vector3,strength:0,radius:0},this.el.addEventListener("loaded",()=>{setTimeout(()=>{this.leftHand=document.querySelector("#left-hand"),this.rightHand=document.querySelector("#right-hand");let t=this.el.querySelector("[gpu-particles]");t&&t.components["gpu-particles"]?(this.particleSystem=t.components["gpu-particles"],console.log("[HandDistance] âœ… Found GPU Particle System")):(t=this.el.querySelector("[synesthetic-particles]"),t&&t.components["synesthetic-particles"]&&(this.particleSystem=t.components["synesthetic-particles"],this.particleSystem.addAttractor(this.centerAttractor),this.particleSystem.addAttractor(this.pointingAttractor),console.log("[HandDistance] âœ… Found CPU Particle System (Legacy)"))),this.leftHand&&(this.leftHand.addEventListener("pinchstarted",()=>this.leftPinching=!0),this.leftHand.addEventListener("pinchended",()=>this.leftPinching=!1),this.leftHand.addEventListener("gesture-fist",()=>this.leftFist=!0),this.leftHand.addEventListener("gesture-fist-end",()=>this.leftFist=!1)),this.rightHand&&(this.rightHand.addEventListener("pinchstarted",()=>this.rightPinching=!0),this.rightHand.addEventListener("pinchended",()=>this.rightPinching=!1),this.rightHand.addEventListener("gesture-fist",()=>this.rightFist=!0),this.rightHand.addEventListener("gesture-fist-end",()=>this.rightFist=!1))},1e3)})},tick:function(t,e){const i=this.el.sceneEl.renderer;if(!i||!i.xr)return;const n=i.xr.getSession();if(!n){this.leftHand&&this.rightHand&&(this.leftHand.object3D.getWorldPosition(this.leftPos),this.rightHand.object3D.getWorldPosition(this.rightPos),this.leftPos.lengthSq()>.1&&this.calculatePhysics(this.leftPos,this.rightPos,null,null));return}const s=i.xr.getFrame(),o=i.xr.getReferenceSpace();if(!s||!o)return;let a=null,c=null,h=null,d=null;for(const r of n.inputSources){if(!r.hand)continue;const T=r.hand.get("wrist"),H=r.hand.get("index-finger-phalanx-proximal"),S=r.hand.get("index-finger-tip"),R=r.hand.get("middle-finger-tip"),b=r.hand.get("pinky-finger-phalanx-proximal");if(!T||!H||!b)continue;const p=s.getJointPose(T,o),m=s.getJointPose(H,o),y=s.getJointPose(b,o),u=S?s.getJointPose(S,o):null,f=R?s.getJointPose(R,o):null;if(!p||!m||!y)continue;const l=new THREE.Vector3(p.transform.position.x,p.transform.position.y,p.transform.position.z),v=new THREE.Vector3(m.transform.position.x,m.transform.position.y,m.transform.position.z),D=new THREE.Vector3(y.transform.position.x,y.transform.position.y,y.transform.position.z),L=new THREE.Vector3().subVectors(v,l),w=new THREE.Vector3().subVectors(D,l),E=new THREE.Vector3().crossVectors(L,w).normalize();if(r.handedness==="left"&&E.negate(),r.handedness==="left"){if(this.leftPos.copy(l),h=E,a=!0,u&&f){const g=new THREE.Vector3(u.transform.position.x,u.transform.position.y,u.transform.position.z),A=new THREE.Vector3(f.transform.position.x,f.transform.position.y,f.transform.position.z),P=g.distanceTo(l),x=A.distanceTo(l);this.isLeftPointing=P-x>.03,this.isLeftPointing&&(this.leftIndexTip.copy(g),this.leftIndexDir.subVectors(g,l).normalize())}}else if(r.handedness==="right"&&(this.rightPos.copy(l),d=E,c=!0,u&&f)){const g=new THREE.Vector3(u.transform.position.x,u.transform.position.y,u.transform.position.z),A=new THREE.Vector3(f.transform.position.x,f.transform.position.y,f.transform.position.z),P=g.distanceTo(l),x=A.distanceTo(l);this.isRightPointing=P-x>.03,this.isRightPointing&&(this.rightIndexTip.copy(g),this.rightIndexDir.subVectors(g,l).normalize())}}a&&c&&this.calculatePhysics(this.leftPos,this.rightPos,h,d)},calculatePhysics:function(t,e,i,n){if(!this.particleSystem)return;this.distance=t.distanceTo(e),this.smoothDistance=this.smoothDistance*.9+this.distance*.1,this.centerAttractor.position.copy(this.centerPos);const s=new THREE.Vector3(0,1,0);let o=0,a=0;if(i&&n&&(o=i.dot(s),a=n.dot(s),this.leftPalmUp=o>.6,this.rightPalmUp=a>.6,Math.random()<.02&&console.log(`[HandDistance] ðŸ•Šï¸ Up Check: L=${o.toFixed(2)} R=${a.toFixed(2)} | Dist=${this.distance.toFixed(2)}`)),this.isRightPointing){const c=this.rightPos,h=this.rightIndexTip,d=new THREE.Vector3().subVectors(h,c).normalize();this.pointingAttractor.position.copy(h),this.pointingAttractor.data={hand:"pointing",mode:"beam",direction:d},this.pointingAttractor.strength=50,this.pointingAttractor.radius=15,Math.random()<.02&&console.log("[HandDistance] ðŸ”¦ BEAM (Right)")}else this.pointingAttractor.strength=0,this.pointingAttractor.radius=0,this.pointingAttractor.data={};if(this.isLeftPointing&&(this.centerAttractor.position.copy(this.leftIndexTip),this.centerAttractor.strength=80,this.centerAttractor.radius=8,this.centerAttractor.data={mode:"singularity",hand:"left"},Math.random()<.02&&console.log("[HandDistance] âš« SINGULARITY (Left)")),o>.8&&a>.8&&!this.leftPinching&&!this.rightPinching&&!this.leftFist&&!this.rightFist){this.resetTimer||(this.resetTimer=0);const c=Date.now();c-this.resetTimer>2e3&&(console.log("[HandDistance] ðŸ”„ DOUBLE PALM DOWN -> RESET (SMOOTH)"),this.particleSystem.smoothReset?this.particleSystem.smoothReset():this.particleSystem.reset(),this.resetTimer=c);return}if(o>.6){this.centerAttractor.position.copy(this.leftPos),this.centerAttractor.data={mode:"levitate",hand:"left"},this.centerAttractor.strength=1,this.centerAttractor.radius=8,Math.random()<.02&&console.log("[HandDistance] ðŸª¶ LEVITATE (Left)");return}if(this.isLeftPointing){this.centerAttractor.position.copy(this.leftIndexTip),this.centerAttractor.strength=80,this.centerAttractor.radius=8,this.centerAttractor.data={mode:"singularity",hand:"left"},Math.random()<.02&&console.log("[HandDistance] âš« SINGULARITY (Left)");return}if(this.centerAttractor.data.mode="center",this.centerAttractor.position.copy(this.centerPos),Math.max(0,Math.min(1,(this.smoothDistance-this.data.minDistance)/(this.data.maxDistance-this.data.minDistance))),this.leftPinching&&this.rightPinching){this.centerAttractor.strength=50,this.centerAttractor.radius=8;return}this.smoothDistance<.15?(this.centerAttractor.strength=-30,this.centerAttractor.radius=2):(this.centerAttractor.strength=10,this.centerAttractor.radius=4+this.smoothDistance*2)}});AFRAME.registerSystem("gesture-detector",{init:function(){this.sceneEl=document.querySelector("a-scene"),this.hands={left:null,right:null},this.gestures={left:"unknown",right:"unknown"},this.gestureCounters={left:{},right:{}},this.STABILITY_THRESHOLD=8,this.state={left:{pinching:!1},right:{pinching:!1}},this.frameCount=0,this.hasSeenXR=!1,console.log("[GestureDetector] âœ… System initialized (Orientation-Independent + Hysteresis)")},registerHand:function(t,e){this.hands[t]=e,console.log(`[GestureDetector] âœ… Registered ${t} hand`)},getGesture:function(t){return this.gestures[t]},tick:function(){this.frameCount++;const t=this.sceneEl.renderer;if(!t||!t.xr)return;const e=t.xr.getSession();if(!e)return;const i=t.xr.getFrame(),n=t.xr.getReferenceSpace();if(!(!i||!n)){this.hasSeenXR||(console.log("[GestureDetector] âœ… XR Session active!"),this.hasSeenXR=!0);for(const s of e.inputSources)s.hand&&this.processHand(s,i,n)}},processHand:function(t,e,i){const n=t.handedness,s=t.hand,o={},a=["wrist","thumb-tip","index-finger-tip","index-finger-phalanx-proximal","middle-finger-tip","middle-finger-phalanx-proximal","ring-finger-tip","ring-finger-phalanx-proximal","pinky-finger-tip","pinky-finger-phalanx-proximal"];for(const h of a){const d=s.get(h);if(!d)continue;const r=e.getJointPose(d,i);r&&(o[h]=new THREE.Vector3(r.transform.position.x,r.transform.position.y,r.transform.position.z))}if(!o.wrist)return;const c=this.classifyGesture(o,n);this.updateGesture(n,c)},isExtended:function(t,e){const i=t[`${e}-finger-tip`],n=t[`${e}-finger-phalanx-proximal`],s=t.wrist;if(!i||!n||!s)return null;const o=i.distanceTo(s),a=n.distanceTo(s);return o>a+.015},isPinching:function(t,e){const i=t["thumb-tip"],n=t["index-finger-tip"];if(!i||!n)return!1;const s=i.distanceTo(n);return this.frameCount%180===0&&console.log(`[Gesture] ${e} Pinch dist: ${(s*100).toFixed(1)}cm (State: ${this.state[e].pinching})`),this.state[e].pinching?s>.04&&(this.state[e].pinching=!1):s<.025&&(this.state[e].pinching=!0),this.state[e].pinching},classifyGesture:function(t,e){const i=this.isExtended(t,"index"),n=this.isExtended(t,"middle"),s=this.isExtended(t,"ring"),o=this.isExtended(t,"pinky");return i&&n&&s&&o?"open":!i&&!n&&!s&&!o?"fist":i&&!n&&!s&&!o?"point":"relaxed"},updateGesture:function(t,e){const i=this.gestureCounters[t];i[e]=(i[e]||0)+1;for(const o in i)o!==e&&(i[o]=0);if(i[e]<this.STABILITY_THRESHOLD||e===this.gestures[t])return;const n=this.gestures[t];this.gestures[t]=e;const s=this.hands[t];if(!s){console.warn(`[GestureDetector] âš ï¸ No element registered for ${t} hand!`);return}console.log(`[GestureDetector] ðŸ“¤ Emitting gesture-${e} on:`,s),s.emit("gesture-change",{hand:t,gesture:e,previous:n}),s.emit(`gesture-${e}`,{hand:t}),n!=="unknown"&&s.emit(`gesture-${n}-end`,{hand:t}),console.log(`[Gesture] ðŸŽ¯ ${t}: ${n} â†’ ${e}`)}});AFRAME.registerComponent("hand-gestures",{schema:{hand:{type:"string",default:"right"}},init:function(){console.log(`[HandGestures] Component init for ${this.data.hand}`),this.gestureSystem=null,this.registered=!1,this.tryRegister(),this.el.sceneEl.addEventListener("loaded",()=>this.tryRegister()),this.el.sceneEl.addEventListener("enter-vr",()=>{console.log(`[HandGestures] VR entered, re-registering ${this.data.hand}`),this.tryRegister()})},tryRegister:function(){this.registered||(this.gestureSystem=this.el.sceneEl.systems["gesture-detector"],this.gestureSystem&&(this.gestureSystem.registerHand(this.data.hand,this.el),this.registered=!0))},getGesture:function(){return this.gestureSystem?this.gestureSystem.getGesture(this.data.hand):"unknown"}});AFRAME.registerComponent("hand-attractor",{schema:{hand:{type:"string"},strength:{default:1},radius:{default:.5}},init:function(){this.isActive=!1;const t=document.querySelector("[synesthetic-particles]");this.particles=t?t.components["synesthetic-particles"]:null,this.position=new THREE.Vector3,this.strength=this.data.strength,this.radius=this.data.radius,this.hand=this.data.hand,console.log(`[HandAttractor] Init ${this.data.hand}`),console.log("[HandAttractor] Setting up listeners on:",this.el),this.el.addEventListener("gesture-pinch",e=>{console.log(`[HandAttractor] ðŸ”¥ GESTURE-PINCH EVENT RECEIVED (${this.data.hand})`,e),this.activate()}),this.el.addEventListener("gesture-pinch-end",e=>{console.log(`[HandAttractor] GESTURE-PINCH-END (${this.data.hand})`),this.deactivate()}),this.el.addEventListener("pinchstarted",()=>{console.log(`[HandAttractor] PINCHSTARTED (${this.data.hand})`),this.activate()}),this.el.addEventListener("pinchended",()=>{console.log(`[HandAttractor] PINCHENDED (${this.data.hand})`),this.deactivate()}),this.el.addEventListener("gripdown",()=>{console.log(`[HandAttractor] GRIPDOWN (${this.data.hand})`),this.activate()}),this.el.addEventListener("gripup",()=>{console.log(`[HandAttractor] GRIPUP (${this.data.hand})`),this.deactivate()}),this.el.addEventListener("gesture-fist",()=>{console.log(`[HandAttractor] GESTURE-FIST (${this.data.hand})`),this.activate("freeze")}),this.el.addEventListener("gesture-fist-end",()=>{console.log(`[HandAttractor] GESTURE-FIST-END (${this.data.hand})`),this.deactivate()}),this.particles||this.el.sceneEl.addEventListener("loaded",()=>{const e=document.querySelector("[synesthetic-particles]");this.particles=e?e.components["synesthetic-particles"]:null})},activate:function(t=null){if(this.isActive&&this.mode===t){console.log(`[HandAttractor] Already active (${this.data.hand})`);return}if(this.isActive=!0,this.mode=t,console.log(`[HandAttractor] âœ… ACTIVATING (${this.data.hand}) Mode: ${t||"standard"}`),!this.particles){const i=document.querySelector("[synesthetic-particles]"),n=document.querySelector("[gpu-particles]");i?(this.particles=i.components["synesthetic-particles"],this.isGPU=!1):n&&(this.particles=n.components["gpu-particles"],this.isGPU=!0)}if(this.particles){if(console.log(`[HandAttractor] ðŸŽ¯ Adding attractor to particle system (${this.data.hand})`),this.isGPU)return;t==="freeze"?(this.strength=0,this.radius=100):(this.strength=50,this.radius=8,t||(t="orb")),this.data.mode=t,this.particles.addAttractor(this)}const e=this.el.components.haptics;e&&e.pulse(.5,50)},deactivate:function(){this.isActive&&(this.isActive=!1,console.log(`[HandAttractor] ðŸ”´ DEACTIVATING (${this.data.hand})`),this.particles&&this.particles.removeAttractor(this))},tick:function(){if(!this.isActive)return;const t=this.el.sceneEl.renderer;if(t&&t.xr){const e=t.xr.getSession(),i=t.xr.getFrame(),n=t.xr.getReferenceSpace();if(e&&i&&n){for(const s of e.inputSources)if(s.handedness===this.data.hand&&s.hand){const o=s.hand.get("wrist");if(o){const a=i.getJointPose(o,n);if(a){this.position.set(a.transform.position.x,a.transform.position.y,a.transform.position.z);return}}}}}this.el.object3D.getWorldPosition(this.position)}});AFRAME.registerComponent("auto-music",{init:function(){const t=async()=>{if(this.system=this.el.sceneEl.systems["audio-analyzer"],this.loaded=!1,!this.system){console.warn("AutoMusic: Audio Analyzer system not found!");return}try{console.log("AutoMusic: Checking store...");const e=await C.getTrack();e?(console.log("AutoMusic: Found track",e.name),await this.system.loadAudio(e),this.loaded=!0,this.tryPlay()):console.log("AutoMusic: No track selected in store.")}catch(e){console.error("AutoMusic: Error loading track",e)}};this.el.sceneEl.hasLoaded?t():this.el.sceneEl.addEventListener("loaded",t),this.el.sceneEl.addEventListener("enter-vr",()=>{this.loaded&&this.tryPlay()}),document.body.addEventListener("click",()=>{this.loaded&&this.tryPlay()},{once:!0}),this.el.sceneEl.addEventListener("play-music",()=>{this.loaded&&this.tryPlay()})},tryPlay:function(){this.system&&(console.log("AutoMusic: Attempting playback..."),this.system.audioContext&&this.system.audioContext.state==="suspended"?(console.log("AutoMusic: Context suspended, resuming..."),this.system.audioContext.resume().then(()=>{console.log("AutoMusic: Context resumed, playing."),this.system.play()}).catch(t=>console.error("AutoMusic: Resume failed",t))):(console.log("AutoMusic: Playing."),this.system.play()))}});
