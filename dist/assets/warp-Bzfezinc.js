import"./music-store-Da5ddBIB.js";import"./auto-music-CU4BUEO4.js";AFRAME.registerComponent("force-grab",{schema:{target:{type:"selector"},speed:{type:"number",default:10},distance:{type:"number",default:2}},init:function(){this.grabbedObject=null,this.originalDamping=0,this.targetPosition=new THREE.Vector3,this.direction=new THREE.Vector3},grab:function(t){this.grabbedObject||(this.grabbedObject=t,t.body&&(this.originalDamping=t.body.linearDamping,t.body.linearDamping=.9,t.body.angularDamping=.9))},release:function(){this.grabbedObject&&(this.grabbedObject.body&&(this.grabbedObject.body.linearDamping=this.originalDamping,this.grabbedObject.body.angularDamping=.01),this.grabbedObject=null)},tick:function(t,e){if(!this.grabbedObject||!this.grabbedObject.body)return;this.el.object3D.getWorldPosition(this.targetPosition),this.el.object3D.getWorldDirection(this.direction),this.direction.multiplyScalar(-1);const i=this.el.object3D.localToWorld(new THREE.Vector3(0,0,-this.distance)),s=this.grabbedObject.object3D.position,n=new THREE.Vector3().copy(i).sub(s).multiplyScalar(this.data.speed);this.grabbedObject.body.velocity.set(n.x,n.y,n.z)}});AFRAME.registerComponent("invito-summon",{schema:{speed:{type:"number",default:20},arrivalDistance:{type:"number",default:.5}},init:function(){this.targetObject=null,this.originalDamping=0,this.vectorToTarget=new THREE.Vector3},summon:function(t){this.targetObject||(this.targetObject=t,t.body&&(this.originalDamping=t.body.linearDamping,t.body.linearDamping=.1,t.body.angularDamping=.1,t.body.wakeUp()))},release:function(){this.targetObject&&(this.targetObject.body&&(this.targetObject.body.linearDamping=this.originalDamping,this.targetObject.body.velocity.set(0,0,0)),this.targetObject=null)},tick:function(t,e){if(!this.targetObject||!this.targetObject.body)return;const i=this.el.object3D.getWorldPosition(new THREE.Vector3),s=this.targetObject.object3D.getWorldPosition(new THREE.Vector3);if(i.distanceTo(s)<this.data.arrivalDistance){this.release();return}this.vectorToTarget.subVectors(i,s).normalize();const n=this.vectorToTarget.multiplyScalar(this.data.speed);this.targetObject.body.velocity.set(n.x,n.y,n.z)}});AFRAME.registerComponent("spell-caster",{schema:{hand:{type:"string",default:"right"},wandLength:{type:"number",default:.3},wandColor:{type:"color",default:"#5c4033"}},init:function(){this.activeSpell="wingardium_leviosa",this.targetEl=null,this.el.setAttribute("force-grab",""),this.forceGrab=this.el.components["force-grab"],this.wandContainer=document.createElement("a-entity"),this.wandContainer.setAttribute("position","0.04 0.05 -0.1"),this.wandContainer.setAttribute("rotation","-45 0 0");const t=document.createElement("a-entity");t.setAttribute("geometry",`primitive: cylinder; radius: 0.01; height: ${this.data.wandLength}`),t.setAttribute("material",`color: ${this.data.wandColor}`),t.setAttribute("rotation","90 0 0"),t.setAttribute("position",`0 0 -${this.data.wandLength/2}`),this.wandContainer.appendChild(t),this.tip=document.createElement("a-entity"),this.tip.setAttribute("geometry","primitive: sphere; radius: 0.015"),this.tip.setAttribute("material","color: #88ccff; emissive: #88ccff; emissiveIntensity: 0.5"),this.tip.setAttribute("position",`0 0 -${this.data.wandLength}`),this.wandContainer.appendChild(this.tip),this.el.appendChild(this.wandContainer),this.wandContainer.setAttribute("raycaster",{objects:"[grabbable], .clickable",far:20,showLine:!0,lineColor:"#88ccff",lineOpacity:.5,direction:new THREE.Vector3(0,0,-1),origin:new THREE.Vector3(0,0,-this.data.wandLength)}),this.onRaycasterIntersection=this.onRaycasterIntersection.bind(this),this.onRaycasterIntersectionCleared=this.onRaycasterIntersectionCleared.bind(this),this.onGripDown=this.onGripDown.bind(this),this.onGripUp=this.onGripUp.bind(this)},play:function(){this.wandContainer.addEventListener("raycaster-intersection",this.onRaycasterIntersection),this.wandContainer.addEventListener("raycaster-intersection-cleared",this.onRaycasterIntersectionCleared),this.el.addEventListener("gripdown",this.onGripDown),this.el.addEventListener("gripup",this.onGripUp),this.el.addEventListener("pinchstarted",this.onGripDown),this.el.addEventListener("pinchended",this.onGripUp)},pause:function(){this.wandContainer&&(this.wandContainer.removeEventListener("raycaster-intersection",this.onRaycasterIntersection),this.wandContainer.removeEventListener("raycaster-intersection-cleared",this.onRaycasterIntersectionCleared)),this.el.removeEventListener("gripdown",this.onGripDown),this.el.removeEventListener("gripup",this.onGripUp),this.el.removeEventListener("pinchstarted",this.onGripDown),this.el.removeEventListener("pinchended",this.onGripUp)},onRaycasterIntersection:function(t){const e=this.wandContainer.components.raycaster.intersections;e&&e.length>0&&(this.targetEl=e[0].object.el,this.targetEl.setAttribute("material","emissive","#333"),console.log("Wand Hit:",this.targetEl.id),this.tip.setAttribute("material","emissiveIntensity","1.0"))},onRaycasterIntersectionCleared:function(){this.targetEl&&(this.targetEl.setAttribute("material","emissive","#000"),this.targetEl=null,this.tip.setAttribute("material","emissiveIntensity","0.5"))},onGripDown:function(t){if(console.log("Wand Cast:",t?t.type:"unknown"),this.activeSpell==="wingardium_leviosa"&&this.targetEl){if(this.targetEl.getAttribute("scene-restarter")!==null){this.targetEl.emit("click");return}console.log("Force Grabbing",this.targetEl),this.forceGrab.grab(this.targetEl),this.tip.setAttribute("material","color","#ff0000"),this.tip.setAttribute("material","emissive","#ff0000"),this.wandContainer.setAttribute("raycaster","lineColor","#ff0000")}},onGripUp:function(t){this.activeSpell==="wingardium_leviosa"&&(this.forceGrab.release(),this.tip.setAttribute("material","color","#88ccff"),this.tip.setAttribute("material","emissive","#88ccff"),this.wandContainer.setAttribute("raycaster","lineColor","#88ccff"))}});AFRAME.registerComponent("scene-restarter",{init:function(){this.el.addEventListener("click",function(){location.reload()})}});AFRAME.registerComponent("palm-locomotion",{schema:{hand:{type:"string",default:"right"},speed:{type:"number",default:1.5}},init:function(){this.pinching=!1,this.previousHandPos=new THREE.Vector3,this.currentHandPos=new THREE.Vector3,this.delta=new THREE.Vector3,this.rigEl=document.getElementById("rig"),this.onPinchStart=this.onPinchStart.bind(this),this.onPinchEnd=this.onPinchEnd.bind(this),this.el.addEventListener("pinchstarted",this.onPinchStart),this.el.addEventListener("pinchended",this.onPinchEnd)},onPinchStart:function(){this.pinching=!0,this.el.object3D.getWorldPosition(this.previousHandPos)},onPinchEnd:function(){this.pinching=!1},tick:function(){!this.pinching||!this.rigEl||(this.el.object3D.getWorldPosition(this.currentHandPos),this.delta.subVectors(this.currentHandPos,this.previousHandPos),this.rigEl.object3D.position.sub(this.delta.multiplyScalar(this.data.speed)),this.el.object3D.getWorldPosition(this.previousHandPos))}});AFRAME.registerComponent("scene-navigator",{schema:{url:{type:"string"}},init:function(){this.el.addEventListener("click",()=>{this.data.url&&(window.location.href=this.data.url)})}});AFRAME.registerComponent("wrist-menu",{schema:{menuId:{type:"string",default:"menu-panel"},toggleGesture:{type:"string",default:"pinchstarted"}},init:function(){if(this.menuEl=document.getElementById(this.data.menuId),this.visible=!1,!this.menuEl){console.warn("Wrist Menu: Menu element not found with ID",this.data.menuId);return}this.menuEl.setAttribute("visible",!1),this.onToggle=this.onToggle.bind(this),this.el.addEventListener(this.data.toggleGesture,this.onToggle)},onToggle:function(){this.visible=!this.visible,this.menuEl.setAttribute("visible",this.visible),console.log("Wrist Menu Toggled:",this.visible)}});AFRAME.registerComponent("magic-wand",{init:function(){this.activeSpell="wingardium_leviosa",this.isHeld=!1,this.holderEl=null,this.el.setAttribute("raycaster",{objects:"[grabbable], .clickable",far:20,showLine:!0,lineColor:"#88ccff",lineOpacity:.5,enabled:!0}),this.el.setAttribute("force-grab",""),this.forceGrab=this.el.components["force-grab"],this.el.setAttribute("invito-summon",""),this.invito=this.el.components["invito-summon"],this.onGrabStart=this.onGrabStart.bind(this),this.onGrabEnd=this.onGrabEnd.bind(this),this.onTriggerDown=this.onTriggerDown.bind(this),this.onTriggerUp=this.onTriggerUp.bind(this),this.onRayIntersection=this.onRayIntersection.bind(this),this.onRayCleared=this.onRayCleared.bind(this),this.el.addEventListener("grab-start",this.onGrabStart),this.el.addEventListener("grab-end",this.onGrabEnd),this.el.addEventListener("raycaster-intersection",this.onRayIntersection),this.el.addEventListener("raycaster-intersection-cleared",this.onRayCleared),this.el.addEventListener("triggerdown",this.onTriggerDown),this.el.addEventListener("pinchstarted",this.onTriggerDown),this.el.addEventListener("gripdown",this.onTriggerDown),this.el.addEventListener("gripup",this.onTriggerUp),this.el.addEventListener("triggerup",this.onTriggerUp),this.el.addEventListener("pinchended",this.onTriggerUp),console.log("Magic Wand Initialized with Invito")},onGrabStart:function(t){console.log("Wand Grabbed by",t.detail.hand.id),this.isHeld=!0,this.holderEl=t.detail.hand},onGrabEnd:function(t){console.log("Wand Released"),this.isHeld=!1,this.holderEl=null,this.forceGrab.release(),this.invito.release()},onRayIntersection:function(t){const e=t.detail.els;e&&e.length>0&&(this.targetEl=e[0],this.targetEl.setAttribute("material","emissive","#333"),this.el.setAttribute("raycaster","lineColor","#aaccff"))},onRayCleared:function(t){this.targetEl&&(this.targetEl.setAttribute("material","emissive","#000"),this.targetEl=null,this.el.setAttribute("raycaster","lineColor","#88ccff"))},onTriggerDown:function(t){if(!this.isHeld)return;if(console.log("Wand Trigger!",t.type),t.type==="gripdown")this.targetEl&&(console.log("Casting Invito!",this.targetEl),this.invito.summon(this.targetEl),this.el.setAttribute("raycaster","lineColor","#00ff00"));else if(this.targetEl){if(this.targetEl.getAttribute("scene-restarter")!==null){this.targetEl.emit("click");return}console.log("Force Grabbing",this.targetEl),this.forceGrab.grab(this.targetEl),this.el.setAttribute("raycaster","lineColor","#ff0000")}},onTriggerUp:function(t){if(!this.isHeld)return;t.type==="gripup"?(this.invito.release(),this.el.setAttribute("raycaster","lineColor","#88ccff")):(this.forceGrab.release(),this.el.setAttribute("raycaster","lineColor","#88ccff"))}});AFRAME.registerComponent("hand-physics",{schema:{radius:{default:.05},offset:{type:"vec3",default:{x:0,y:0,z:0}}},init:function(){if(this.system=this.el.sceneEl.systems.physics,!this.system){console.error("Physics system not found!");return}this.el.body||this.el.setAttribute("static-body",{shape:"sphere",sphereRadius:this.data.radius}),this.el.addEventListener("body-loaded",t=>{try{this.body=t.detail.body,window.CANNON?(this.body.type=window.CANNON.Body.KINEMATIC,this.body.mass=0,this.body.updateMassProperties(),this.body.collisionFilterGroup=1,this.body.collisionFilterMask=1,console.log("Hand Physics Body Loaded (Kinematic)",this.el.id)):console.warn("CANNON global not found! Physics body might behave unexpectedly.")}catch(e){console.error("Error setting up hand physics body:",e)}})},tick:function(){if(!this.body)return;const t=this.el.object3D.position,e=this.el.object3D.quaternion;this.body.position.set(t.x+this.data.offset.x,t.y+this.data.offset.y,t.z+this.data.offset.z),this.body.quaternion.set(e.x,e.y,e.z,e.w)}});AFRAME.registerComponent("audio-reactive",{schema:{src:{type:"selector"},fftSize:{type:"int",default:2048},smoothing:{type:"number",default:.8},enabled:{type:"boolean",default:!0}},init:function(){this.audioContext=null,this.analyser=null,this.dataArray=null,this.source=null,this.isAudioRunning=!1,this.startAudio=this.startAudio.bind(this),this.onEnterVR=this.onEnterVR.bind(this),["click","touchstart","enter-vr"].forEach(t=>{window.addEventListener(t,this.startAudio,{once:!0})}),this.el.addEventListener("enter-vr",this.onEnterVR)},initAudioContext:function(){if(this.audioContext)return;const t=window.AudioContext||window.webkitAudioContext;if(this.audioContext=new t,this.analyser=this.audioContext.createAnalyser(),this.analyser.fftSize=this.data.fftSize,this.analyser.smoothingTimeConstant=this.data.smoothing,this.bufferLength=this.analyser.frequencyBinCount,this.dataArray=new Uint8Array(this.bufferLength),this.data.src){const e=this.data.src;(e.tagName==="AUDIO"||e.tagName==="VIDEO")&&(this.source=this.audioContext.createMediaElementSource(e),this.source.connect(this.analyser),this.analyser.connect(this.audioContext.destination))}else navigator.mediaDevices&&navigator.mediaDevices.getUserMedia&&(console.log("Requesting microphone access..."),navigator.mediaDevices.getUserMedia({audio:!0}).then(e=>{console.log("Microphone access granted"),this.source=this.audioContext.createMediaStreamSource(e),this.source.connect(this.analyser)}).catch(e=>console.error("Microphone access denied:",e)));this.isAudioRunning=!0,console.log("Audio Context Initialized")},startAudio:function(){this.data.enabled&&(this.audioContext&&this.audioContext.state==="suspended"&&this.audioContext.resume().then(()=>{console.log("Audio Context Resumed")}),this.audioContext||this.initAudioContext())},onEnterVR:function(){this.startAudio()},tick:function(){if(!this.isAudioRunning||!this.analyser)return;this.analyser.getByteFrequencyData(this.dataArray);const t=this.getAverageFrequency(0,10),e=this.getAverageFrequency(10,100),i=this.getAverageFrequency(100,500);this.el.emit("audio-analysis",{bass:t/255,mid:e/255,high:i/255,raw:this.dataArray}),this.el.systems["audio-reactive"]||this.el.sceneEl.setAttribute("audio-reactive-system","")},getAverageFrequency:function(t,e){let i=0;const s=Math.min(t+e,this.bufferLength),a=s-t;if(a===0)return 0;for(let n=t;n<s;n++)i+=this.dataArray[n];return i/a}});AFRAME.registerSystem("audio-reactive",{init:function(){this.data={bass:0,mid:0,high:0},this.el.addEventListener("audio-analysis",t=>{this.data=t.detail})},getAudioData:function(){return this.data}});AFRAME.registerComponent("dimension-warp",{schema:{count:{type:"number",default:400}},init:function(){this.audioSystem=this.el.sceneEl.systems["audio-analyzer"],this.dummy=new THREE.Object3D,this.createTunnel(),this.tick=this.tick.bind(this)},createTunnel:function(){const t=new THREE.CapsuleGeometry(.04,6,8,16);t.rotateX(Math.PI/2),this.uniforms={uTime:{value:0},uBass:{value:0},uColor:{value:new THREE.Color(65535)},uCoreColor:{value:new THREE.Color(16777215)}};const e=new THREE.ShaderMaterial({uniforms:this.uniforms,vertexShader:`
                varying vec3 vNormal;
                varying vec3 vViewPosition;
                
                void main() {
                    vNormal = normalize(normalMatrix * normal);
                    vec4 mvPosition = modelViewMatrix * instanceMatrix * vec4(position, 1.0);
                    vViewPosition = -mvPosition.xyz;
                    gl_Position = projectionMatrix * mvPosition;
                }
            `,fragmentShader:`
                uniform vec3 uColor;
                uniform vec3 uCoreColor;
                uniform float uBass;
                
                varying vec3 vNormal;
                varying vec3 vViewPosition;

                void main() {
                    // Normalize View Direction
                    vec3 viewDir = normalize(vViewPosition);
                    vec3 normal = normalize(vNormal);

                    // Calculate "Facing Ratio" (0.0 at edge, 1.0 at center)
                    float facing = max(0.0, dot(normal, viewDir));
                    
                    // "Fresnel" inverse -> Bloom Core logic
                    // High power = tight core. varying with bass.
                    float coreSharpness = 3.0 - (uBass * 2.0); // Bass makes core grow (sharper -> softer)
                    float core = pow(facing, coreSharpness);

                    // Mix Glow and White Core
                    // Edge is uColor, Center approaches uCoreColor
                    vec3 finalColor = mix(uColor, uCoreColor, core);
                    
                    // Boost intensity (Neon Brightness) for Additive Blend
                    float intensity = 1.5 + (uBass * 5.0);
                    
                    // Soft edges to prevent "net" artifacts
                    float alpha = pow(facing, 0.5); 

                    gl_FragColor = vec4(finalColor * intensity, alpha);
                }
            `,blending:THREE.AdditiveBlending,depthWrite:!1,transparent:!0,side:THREE.FrontSide}),i=this.data.count;this.mesh=new THREE.InstancedMesh(t,e,i),this.mesh.instanceMatrix.setUsage(THREE.DynamicDrawUsage),this.particles=[];for(let s=0;s<i;s++){const a=(Math.random()-.5)*60,n=(Math.random()-.5)*60,r=Math.random()*200-150;this.particles.push({x:a,y:n,z:r,rotation:Math.random()*Math.PI,speedOffset:Math.random()*.5+.8}),this.dummy.position.set(a,n,r),this.dummy.rotation.z=this.particles[s].rotation,this.dummy.scale.set(1,1,1),this.dummy.updateMatrix(),this.mesh.setMatrixAt(s,this.dummy.matrix)}this.el.setObject3D("warp-tunnel",this.mesh)},tick:function(t,e){if(!this.mesh)return;let i=0;if(this.audioSystem&&this.audioSystem.isPlaying){const r=this.audioSystem.getBands();r&&(i=r.bass)}else i=(Math.sin(t*.003)*.5+.5)*.1;this.uniforms.uBass.value=i,this.uniforms.uTime.value=t;const s=e/1e3,n=(30+i*200)*s;for(let r=0;r<this.particles.length;r++){const o=this.particles[r];o.z+=n*o.speedOffset,o.z>20&&(o.z=-150,o.x=(Math.random()-.5)*60,o.y=(Math.random()-.5)*60,o.rotation=Math.random()*Math.PI),this.dummy.position.set(o.x,o.y,o.z),this.dummy.rotation.z=o.rotation;const h=1+i*1.5;this.dummy.scale.set(h,h,1),this.dummy.updateMatrix(),this.mesh.setMatrixAt(r,this.dummy.matrix)}this.mesh.instanceMatrix.needsUpdate=!0}});console.log("VR Environment Loaded - Hybrid Mode with Grabbable Wand & Invito");AFRAME.registerComponent("hello-world",{init:function(){console.log("Hello, World!")}});
